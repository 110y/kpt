/**
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

var helpers = require('./helpers'),
    should  = require('should'),
    needle  = require('./../'),
    server;

var port = 7707;

describe('Basic Auth', function() {

  before(function(done) {
    server = helpers.server({ port: port }, done);
  })

  after(function(done) {
    server.close(done);
  })

  ///////////////// helpers

  var get_auth = function(header) {
    var token  = header.split(/\s+/).pop();
    return token && Buffer.from(token, 'base64').toString().split(':');
  }

  describe('when neither username or password are passed', function() {

    it('doesnt send any Authorization headers', function(done) {
      needle.get('localhost:' + port, { parse: true }, function(err, resp) {
        var sent_headers = resp.body.headers;
        Object.keys(sent_headers).should.not.containEql('authorization');
        done();
      })
    })

  })

  describe('when username is an empty string, and password is a valid string', function() {

    var opts = { username: '', password: 'foobar', parse: true };

    it('doesnt send any Authorization headers', function(done) {
      needle.get('localhost:' + port, { parse: true }, function(err, resp) {
        var sent_headers = resp.body.headers;
        Object.keys(sent_headers).should.not.containEql('authorization');
        done();
      })
    })

  });

  describe('when username is a valid string, but no username is passed', function() {

    var opts = { username: 'foobar', parse: true };

    it('sends Authorization header', function(done) {
      needle.get('localhost:' + port, opts, function(err, resp) {
        var sent_headers = resp.body.headers;
        Object.keys(sent_headers).should.containEql('authorization');
        done();
      })
    })

    it('Basic Auth only includes username, without colon', function(done) {
      needle.get('localhost:' + port, opts, function(err, resp) {
        var sent_headers = resp.body.headers;
        var auth = get_auth(sent_headers['authorization']);
        auth[0].should.equal('foobar');
        auth.should.have.lengthOf(1);
        done();
      })
    })

  })

  describe('when username is a valid string, and password is null', function() {

    var opts = { username: 'foobar', password: null, parse: true };

    it('sends Authorization header', function(done) {
      needle.get('localhost:' + port, opts, function(err, resp) {
        var sent_headers = resp.body.headers;
        Object.keys(sent_headers).should.containEql('authorization');
        done();
      })
    })

    it('Basic Auth only includes both username and password', function(done) {
      needle.get('localhost:' + port, opts, function(err, resp) {
        var sent_headers = resp.body.headers;
        var auth = get_auth(sent_headers['authorization']);
        auth[0].should.equal('foobar');
        auth[1].should.equal('');
        done();
      })
    })

  })

  describe('when username is a valid string, and password is an empty string', function() {

    var opts = { username: 'foobar', password: '', parse: true };

    it('sends Authorization header', function(done) {
      needle.get('localhost:' + port, opts, function(err, resp) {
        var sent_headers = resp.body.headers;
        Object.keys(sent_headers).should.containEql('authorization');
        done();
      })
    })

    it('Basic Auth only includes both username and password', function(done) {
      needle.get('localhost:' + port, opts, function(err, resp) {
        var sent_headers = resp.body.headers;
        var auth = get_auth(sent_headers['authorization']);
        auth[0].should.equal('foobar');
        auth[1].should.equal('');
        auth.should.have.lengthOf(2);
        done();
      })
    })

  })

  describe('when username AND password are non empty strings', function() {

    var opts = { username: 'foobar', password: 'jakub', parse: true };

    it('sends Authorization header', function(done) {
      needle.get('localhost:' + port, opts, function(err, resp) {
        var sent_headers = resp.body.headers;
        Object.keys(sent_headers).should.containEql('authorization');
        done();
      })
    })

    it('Basic Auth only includes both user and password', function(done) {
      needle.get('localhost:' + port, opts, function(err, resp) {
        var sent_headers = resp.body.headers;
        var auth = get_auth(sent_headers['authorization']);
        auth[0].should.equal('foobar');
        auth[1].should.equal('jakub');
        auth.should.have.lengthOf(2);
        done();
      })
    })

  })

  describe('URL with @ but not username/pass', function() {
    it('doesnt send Authorization header', function(done) {
      var url = 'localhost:' + port + '/abc/@def/xyz.zip';

      needle.get(url, {}, function(err, resp) {
        var sent_headers = resp.body.headers;
        Object.keys(sent_headers).should.not.containEql('authorization');
        done();
      })
    })

    it('sends user:pass headers if passed via options', function(done) {
      var url = 'localhost:' + port + '/abc/@def/xyz.zip';

      needle.get(url, { username: 'foo' }, function(err, resp) {
        var sent_headers = resp.body.headers;
        Object.keys(sent_headers).should.containEql('authorization');
        sent_headers['authorization'].should.eql('Basic Zm9v')
        done();
      })
    })
  })

  describe('when username/password are included in URL', function() {
    var opts = { parse: true };

    it('sends Authorization header', function(done) {
      needle.get('foobar:jakub@localhost:' + port, opts, function(err, resp) {
        var sent_headers = resp.body.headers;
        Object.keys(sent_headers).should.containEql('authorization');
        done();
      })
    })

    it('Basic Auth only includes both user and password', function(done) {
      needle.get('foobar:jakub@localhost:' + port, opts, function(err, resp) {
        var sent_headers = resp.body.headers;
        var auth = get_auth(sent_headers['authorization']);
        auth[0].should.equal('foobar');
        auth[1].should.equal('jakub');
        auth.should.have.lengthOf(2);
        done();
      })
    })

  })

})
